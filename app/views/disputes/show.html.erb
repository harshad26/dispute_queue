<div style="margin-bottom: 20px;">
  <%= link_to "â† Back to Queue", disputes_path, style: "color: #666; text-decoration: none;" %>
</div>

<div style="display: flex; gap: 30px; align-items: flex-start;">
  <!-- Main Column -->
  <div style="flex: 2;">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Dispute #<%= @dispute.id %></h2>
        <span class="status-badge status-<%= @dispute.status %>" style="font-size: 14px; padding: 6px 12px;">
          <%= @dispute.status.humanize.upcase %>
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
        <div>
          <label style="color: #888; display: block; margin-bottom: 4px;">Dispute ID</label>
          <div><%= @dispute.provider_id %></div>
        </div>
        <div>
          <label style="color: #888; display: block; margin-bottom: 4px;">Charge ID</label>
          <div><%= @dispute.charge.provider_id %></div>
        </div>
        <div>
          <label style="color: #888; display: block; margin-bottom: 4px;">Amount</label>
          <div style="font-weight: 500;"><%= number_to_currency(@dispute.amount_cents / 100.0, unit: @dispute.charge.currency.upcase + " ") %></div>
        </div>
        <div>
          <label style="color: #888; display: block; margin-bottom: 4px;">Created</label>
          <div><%= @dispute.created_at.strftime("%b %d, %Y %H:%M") %></div>
        </div>
        <% if @dispute.reopen_reason.present? %>
          <div style="grid-column: span 2; background-color: #fff3e0; padding: 10px; border-radius: 4px; margin-top: 10px;">
             <label style="color: #e65100; display: block; margin-bottom: 4px; font-weight: 500;">Reopen Justification</label>
             <div style="color: #333;"><%= @dispute.reopen_reason %></div>
          </div>
        <% end %>
      </div>
    </div>
    
    <h3>Evidence Timeline</h3>
    <div class="card">
      <% if @dispute.evidences.any? %>
        <% @dispute.evidences.each do |evidence| %>
          <div style="padding: 15px 0; border-bottom: 1px solid #f5f5f5;">
            <div style="font-weight: 500; margin-bottom: 4px;">Attached File</div>
            <div style="color: #555; margin-bottom: 8px;"><%= evidence.description %></div>
            <% if current_user.can_remove_evidence? %>
              <div style="float: right;">
                <%= button_to "Delete", destroy_evidence_dispute_path(@dispute, evidence_id: evidence.id), method: :delete, data: { turbo_confirm: "Are you sure?" }, style: "color: #c62828; background: none; border: none; font-size: 12px; cursor: pointer; text-decoration: underline;" %>
              </div>
            <% end %>
            <% if evidence.file.attached? %>
               <div style="font-size: 12px; color: #888;">ðŸ“Ž <%= evidence.file.filename %></div>
            <% end %>
            <div style="font-size: 12px; color: #aaa; margin-top: 4px;"><%= time_ago_in_words(evidence.created_at) %> ago</div>
          </div>
        <% end %>
      <% else %>
        <p style="color: #888; font-style: italic;">No evidence attached yet.</p>
      <% end %>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div style="flex: 1;">
    <div class="card">
      <h3 style="margin-top: 0;">Actions</h3>
      
      <% if current_user.can_manage_disputes? %>
        <% if @dispute.open? %>
          <%= form_with url: upload_evidence_dispute_path(@dispute), local: true,  multipart: true do |form| %>
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: 500; margin-bottom: 6px;">Attach Evidence</label>
              <%= form.text_area :description, placeholder: "Describe this evidence...", style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px;" %>
              <%= form.file_field :evidence_file, style: "font-size: 13px;" %>
            </div>
            <%= form.submit "Upload Evidence", class: "btn", style: "width: 100%; background: #eee; border: 1px solid #ccc;" %>
          <% end %>
          
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
          
          <%= button_to "Submit Evidence to Network", dispute_path(@dispute, transition: "submit_evidence"), method: :patch, class: "btn btn-primary", style: "width: 100%; margin-bottom: 10px;" %>
          
        <% elsif @dispute.evidence_submitted? %>
          <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
            Evidence has been submitted. Waiting for the network decision.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <%= button_to "Won", dispute_path(@dispute, transition: "won"), method: :patch, class: "btn", style: "width: 100%; background: #e8f5e9; color: #2e7d32;" %>
            <%= button_to "Lost", dispute_path(@dispute, transition: "lost"), method: :patch, class: "btn", style: "width: 100%; background: #ffebee; color: #c62828;" %>
          </div>
        <% end %>
      <% else %>
         <p style="font-style: italic; color: #888;">Read-only mode (Signed in as <%= current_user.role %>)</p>
      <% end %>
      
      <% if @dispute.closed? %>
        <div style="text-align: center; padding: 20px 0;">
          <div style="font-size: 40px; margin-bottom: 10px;">
             <%= @dispute.closed_won? ? "ðŸŽ‰" : "ðŸ’¸" %>
          </div>
          <div style="font-weight: 600;">
            Resolved as <%= @dispute.status.humanize.upcase %>
          </div>
        </div>

        <% if current_user.can_reopen? %>
          <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
          
          <div style="margin-top: 20px;">
            <h4 style="margin-top: 0; margin-bottom: 10px;">Reopen Dispute</h4>
            <%= form_with url: dispute_path(@dispute), method: :patch, local: true do |form| %>
              <%= hidden_field_tag :transition, "reopen" %>
              <div style="margin-bottom: 15px;">
                <%= text_area_tag :reopen_reason, nil, placeholder: "Justification for reopening...", style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; min-height: 80px;", required: true %>
              </div>
              <%= form.submit "Reopen Dispute", class: "btn", style: "width: 100%; background: #fff3e0; color: #e65100; border: 1px solid #ffcc80;" %>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
